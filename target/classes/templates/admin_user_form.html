<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title th:text="${user.id != null ? 'Edit User' : 'Add User'}"></title>

    <!-- Bootstrap & DataTables CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f9fafb; }
        .sidebar { min-height: 100vh; background-color: #fff; border-right: 1px solid #e5e7eb; }
        .sidebar h2 { color: #2563eb; font-weight: 600; margin-bottom: 1.5rem; }
        .sidebar a { display: flex; align-items: center; gap: 0.5rem; color: #1e293b; padding: 0.5rem 1rem;
                     border-radius: 0.75rem; text-decoration: none; transition: all 0.3s; }
        .sidebar a:hover { background-color: #f1f5f9; color: #2563eb; }
        .sidebar .active { background-color: #f1f5f9; color: #2563eb; }
        .icon { font-size: 1.25rem; }
        .form-box { background: #fff; padding: 1.5rem; border-radius: 0.75rem;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <nav class="col-md-2 d-none d-md-block sidebar py-4 px-3">
            <h4>Admin Panel</h4>
            <a th:href="@{/admin}"><div class="icon">üìä</div><span>Dashboard</span></a>
            <a th:href="@{/admin/departments}"><div class="icon">üè¢</div><span>Departments</span></a>
            <a th:href="@{/admin/users}" class="active"><div class="icon">üë§</div><span>Users</span></a>
        </nav>

        <!-- Main Content -->
        <main class="col-md-10 ms-sm-auto px-4 py-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 th:text="${user.id != null ? 'Edit User' : 'Add New User'}"></h1>
                <a th:href="@{/admin/users}" class="btn btn-secondary">‚Üê Back to Users</a>
            </div>

            <!-- Form Box -->
            <div class="form-box">
                <form th:action="@{${user.id != null ? '/admin/users/update/' + user.id : '/admin/users/save'}}" method="post">

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="name" class="form-label fw-semibold">Full Name</label>
                            <input type="text" class="form-control" id="name" name="name" th:value="${user.name}" required>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="email" class="form-label fw-semibold">Email</label>
                            <input type="email" class="form-control" id="email" name="email" th:value="${user.email}" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="phoneNo" class="form-label fw-semibold">Phone Number</label>
                            <input type="text" class="form-control" id="phoneNo" name="phoneNo" th:value="${user.phoneNo}">
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="username" class="form-label fw-semibold">Username</label>
                            <input type="text" class="form-control" id="username" name="username" th:value="${user.username}" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="password" class="form-label fw-semibold">Password</label>
                            <input type="password" class="form-control" id="password" name="password" th:value="${user.password}" required>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="designation" class="form-label fw-semibold">Designation</label>
                            <input type="text" class="form-control" id="designation" name="designation" th:value="${user.designation}">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="role" class="form-label fw-semibold">Role</label>
                            <select class="form-select" id="role" name="roleId" required>
                                <option value="">-- Select Role --</option>
                                <option th:each="r : ${roles}" 
                                        th:value="${r.roleId}" 
                                        th:text="${r.roleName}" 
                                        th:selected="${user.role != null and user.role.roleId == r.roleId}">
                                </option>
                            </select>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="deptSelect" class="form-label fw-semibold">Select Department</label>
                            <div class="input-group">
                                <select id="deptSelect" class="form-select">
                                    <option th:each="dept : ${departments}" 
                                            th:value="${dept.deptId}" 
                                            th:text="${dept.deptName}">
                                    </option>
                                </select>
                                <button type="button" class="btn btn-outline-primary" onclick="addDept()">Add</button>
                            </div>
                        </div>
                    </div>

                    <!-- Selected Departments -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Selected Departments</label>
                        <ul id="selectedDepts" class="list-group">
                        </ul>
                    </div>

                    <!-- Hidden input to submit selected department IDs -->
                    <input type="hidden" name="departmentIds" id="departmentIdsInput" />

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">üíæ Save</button>
                        <a th:href="@{/admin/users}" class="btn btn-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </main>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const selected = [];
    
    function addDept() {
        const select = document.getElementById('deptSelect');
        const deptId = select.value;
        const deptName = select.options[select.selectedIndex].text;

        if (!selected.includes(deptId)) {
            selected.push(deptId);
            const ul = document.getElementById('selectedDepts');
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.textContent = deptName;
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn btn-sm btn-danger';
            btn.textContent = 'Remove';
            btn.onclick = () => {
                ul.removeChild(li);
                selected.splice(selected.indexOf(deptId), 1);
                document.getElementById('departmentIdsInput').value = selected.join(',');
            };
            li.appendChild(btn);
            ul.appendChild(li);

            // Update hidden input
            document.getElementById('departmentIdsInput').value = selected.join(',');
        }
    }
</script>
</body>
</html>